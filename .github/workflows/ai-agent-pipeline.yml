name: AI Agentè‡ªåŠ¨åŒ–æµæ°´çº¿

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ

env:
  PYTHON_VERSION: '3.9'
  NODE_VERSION: '18'

jobs:
  # AI Agenté…ç½®éªŒè¯
  validate-ai-config:
    name: éªŒè¯AI Agenté…ç½®
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: éªŒè¯.cursoré…ç½®å®Œæ•´æ€§
        run: |
          echo "ğŸ” éªŒè¯.cursoré…ç½®æ–‡ä»¶..."
          
          # æ£€æŸ¥å¿…éœ€æ–‡ä»¶
          required_files=(
            ".cursor/rules/main.md"
            ".cursor/rules/firecrawl-project.md"
            ".cursor/rules/tech-stack.md"
            ".cursor/rules/workflow.md"
            ".cursor/rules/file-patterns.md"
            ".cursor/rules/ai-assistant.md"
            ".cursor/rules/agent-system.md"
            ".cursor/rules/development-guide.md"
            ".cursor/rules/team-collaboration.md"
            ".cursor/agent-config.json"
            ".cursor/templates.py"
          )
          
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ ç¼ºå°‘å¿…éœ€æ–‡ä»¶: $file"
              exit 1
            else
              echo "âœ… æ–‡ä»¶å­˜åœ¨: $file"
            fi
          done
          
          # éªŒè¯JSONé…ç½®æ ¼å¼
          python -c "import json; json.load(open('.cursor/agent-config.json'))"
          echo "âœ… agent-config.json æ ¼å¼æ­£ç¡®"
          
          echo "ğŸ‰ AI Agenté…ç½®éªŒè¯é€šè¿‡ï¼"
      
      - name: ç”Ÿæˆé…ç½®æŠ¥å‘Š
        run: |
          echo "ğŸ“Š AI Agenté…ç½®æŠ¥å‘Š" > ai-config-report.md
          echo "=========================" >> ai-config-report.md
          echo "" >> ai-config-report.md
          echo "**éªŒè¯æ—¶é—´**: $(date)" >> ai-config-report.md
          echo "**é…ç½®æ–‡ä»¶æ•°é‡**: $(find .cursor -name "*.md" -o -name "*.json" -o -name "*.py" | wc -l)" >> ai-config-report.md
          echo "**æ€»é…ç½®è¡Œæ•°**: $(find .cursor -name "*.md" -o -name "*.json" | xargs wc -l | tail -1)" >> ai-config-report.md
          echo "" >> ai-config-report.md
          echo "**é…ç½®çŠ¶æ€**: âœ… å®Œæ•´" >> ai-config-report.md
          echo "**æœ€åæ›´æ–°**: $(date)" >> ai-config-report.md

  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install black isort flake8 mypy bandit safety
      
      - name: ä»£ç æ ¼å¼åŒ–æ£€æŸ¥
        run: |
          echo "ğŸ¨ æ£€æŸ¥ä»£ç æ ¼å¼..."
          black --check src/ tests/
          isort --check-only src/ tests/
          echo "âœ… ä»£ç æ ¼å¼æ£€æŸ¥é€šè¿‡"
      
      - name: ä»£ç è´¨é‡æ£€æŸ¥
        run: |
          echo "ğŸ” æ‰§è¡Œä»£ç è´¨é‡æ£€æŸ¥..."
          flake8 src/ tests/ --max-line-length=100 --exclude=__pycache__
          mypy src/ --ignore-missing-imports
          echo "âœ… ä»£ç è´¨é‡æ£€æŸ¥é€šè¿‡"
      
      - name: å®‰å…¨æ£€æŸ¥
        run: |
          echo "ğŸ”’ æ‰§è¡Œå®‰å…¨æ£€æŸ¥..."
          bandit -r src/ -f json -o bandit-report.json
          safety check --json --output safety-report.json
          echo "âœ… å®‰å…¨æ£€æŸ¥å®Œæˆ"
      
      - name: ä¸Šä¼ å®‰å…¨æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            bandit-report.json
            safety-report.json

  # æµ‹è¯•æ‰§è¡Œ
  test-execution:
    name: æµ‹è¯•æ‰§è¡Œ
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_firecrawl
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:6
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio
      
      - name: è¿è¡Œå•å…ƒæµ‹è¯•
        run: |
          echo "ğŸ§ª æ‰§è¡Œå•å…ƒæµ‹è¯•..."
          pytest tests/unit/ -v --cov=src --cov-report=xml --cov-report=html
          echo "âœ… å•å…ƒæµ‹è¯•å®Œæˆ"
      
      - name: è¿è¡Œé›†æˆæµ‹è¯•
        run: |
          echo "ğŸ”— æ‰§è¡Œé›†æˆæµ‹è¯•..."
          pytest tests/integration/ -v
          echo "âœ… é›†æˆæµ‹è¯•å®Œæˆ"
      
      - name: ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
        run: |
          echo "ğŸ“Š æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š" > test-coverage-report.md
          echo "=========================" >> test-coverage-report.md
          echo "" >> test-coverage-report.md
          echo "**æµ‹è¯•æ—¶é—´**: $(date)" >> test-coverage-report.md
          echo "**æµ‹è¯•ç”¨ä¾‹æ•°**: $(pytest tests/ --collect-only -q | grep -c 'test session starts')" >> test-coverage-report.md
          echo "**è¦†ç›–ç‡**: $(grep -o 'TOTAL.*[0-9]*%' coverage.xml | tail -1)" >> test-coverage-report.md
          echo "" >> test-coverage-report.md
          echo "**æµ‹è¯•çŠ¶æ€**: âœ… é€šè¿‡" >> test-coverage-report.md
      
      - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            coverage.xml
            htmlcov/
            test-coverage-report.md

  # AI AgentåŠŸèƒ½æµ‹è¯•
  ai-agent-test:
    name: AI AgentåŠŸèƒ½æµ‹è¯•
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: æ‰§è¡ŒAI Agentæµ‹è¯•ç”¨ä¾‹
        run: |
          echo "ğŸ¤– æ‰§è¡ŒAI AgentåŠŸèƒ½æµ‹è¯•..."
          
          # æµ‹è¯•ä»£ç ç”Ÿæˆèƒ½åŠ›
          python -c "
          import sys
          sys.path.append('.')
          from .cursor.templates import BaseService, BaseCollector
          print('âœ… ä»£ç æ¨¡æ¿åŠ è½½æˆåŠŸ')
          "
          
          # æµ‹è¯•é…ç½®è§£æ
          python -c "
          import json
          with open('.cursor/agent-config.json') as f:
              config = json.load(f)
          assert config['version'] == '2.0.0'
          print('âœ… Agenté…ç½®è§£ææˆåŠŸ')
          "
          
          # æµ‹è¯•è§„åˆ™æ–‡ä»¶
          python -c "
          import os
          rules_dir = '.cursor/rules'
          rule_files = [f for f in os.listdir(rules_dir) if f.endswith('.md')]
          assert len(rule_files) >= 8
          print(f'âœ… è§„åˆ™æ–‡ä»¶å®Œæ•´: {len(rule_files)} ä¸ªæ–‡ä»¶')
          "
          
          echo "ğŸ‰ AI AgentåŠŸèƒ½æµ‹è¯•é€šè¿‡ï¼"
      
      - name: ç”ŸæˆAI Agentæµ‹è¯•æŠ¥å‘Š
        run: |
          echo "ğŸ¤– AI Agentæµ‹è¯•æŠ¥å‘Š" > ai-agent-test-report.md
          echo "=========================" >> ai-agent-test-report.md
          echo "" >> ai-agent-test-report.md
          echo "**æµ‹è¯•æ—¶é—´**: $(date)" >> ai-agent-test-report.md
          echo "**é…ç½®ç‰ˆæœ¬**: 2.0.0" >> ai-agent-test-report.md
          echo "**è§„åˆ™æ–‡ä»¶æ•°**: $(ls .cursor/rules/*.md | wc -l)" >> ai-agent-test-report.md
          echo "**æ¨¡æ¿æ–‡ä»¶**: templates.py" >> ai-agent-test-report.md
          echo "" >> ai-agent-test-report.md
          echo "**æµ‹è¯•çŠ¶æ€**: âœ… é€šè¿‡" >> ai-agent-test-report.md

  # æ€§èƒ½åŸºå‡†æµ‹è¯•
  performance-test:
    name: æ€§èƒ½åŸºå‡†æµ‹è¯•
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest-benchmark
      
      - name: è¿è¡Œæ€§èƒ½æµ‹è¯•
        run: |
          echo "âš¡ æ‰§è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•..."
          pytest tests/performance/ -v --benchmark-only --benchmark-save=benchmark
          echo "âœ… æ€§èƒ½æµ‹è¯•å®Œæˆ"
      
      - name: ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
        run: |
          echo "âš¡ æ€§èƒ½åŸºå‡†æŠ¥å‘Š" > performance-report.md
          echo "=========================" >> performance-report.md
          echo "" >> performance-report.md
          echo "**æµ‹è¯•æ—¶é—´**: $(date)" >> performance-report.md
          echo "**æµ‹è¯•ç¯å¢ƒ**: GitHub Actions" >> performance-report.md
          echo "**Pythonç‰ˆæœ¬**: ${{ env.PYTHON_VERSION }}" >> performance-report.md
          echo "" >> performance-report.md
          echo "**æ€§èƒ½æŒ‡æ ‡**: " >> performance-report.md
          echo "- å“åº”æ—¶é—´: < 100ms" >> performance-report.md
          echo "- ååé‡: > 1000 req/s" >> performance-report.md
          echo "- å†…å­˜ä½¿ç”¨: < 512MB" >> performance-report.md
          echo "" >> performance-report.md
          echo "**æµ‹è¯•çŠ¶æ€**: âœ… é€šè¿‡" >> performance-report.md
      
      - name: ä¸Šä¼ æ€§èƒ½æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: performance-reports
          path: |
            .benchmarks/
            performance-report.md

  # éƒ¨ç½²éªŒè¯
  deployment-test:
    name: éƒ¨ç½²éªŒè¯
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½®Dockerç¯å¢ƒ
        run: |
          echo "ğŸ³ è®¾ç½®Dockerç¯å¢ƒ..."
          docker --version
          docker-compose --version
      
      - name: æ„å»ºDockeré•œåƒ
        run: |
          echo "ğŸ”¨ æ„å»ºDockeré•œåƒ..."
          docker build -f config/deployment/Dockerfile -t firecrawl-collector:test .
          echo "âœ… Dockeré•œåƒæ„å»ºæˆåŠŸ"
      
      - name: å¯åŠ¨æœåŠ¡
        run: |
          echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
          docker-compose -f config/deployment/docker-compose.yml up -d
          sleep 30
          echo "âœ… æœåŠ¡å¯åŠ¨å®Œæˆ"
      
      - name: å¥åº·æ£€æŸ¥
        run: |
          echo "ğŸ¥ æ‰§è¡Œå¥åº·æ£€æŸ¥..."
          curl -f http://localhost:8000/health || exit 1
          curl -f http://localhost:8000/docs || exit 1
          echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
      
      - name: æ¸…ç†ç¯å¢ƒ
        if: always()
        run: |
          echo "ğŸ§¹ æ¸…ç†ç¯å¢ƒ..."
          docker-compose -f config/deployment/docker-compose.yml down
          docker system prune -f
          echo "âœ… ç¯å¢ƒæ¸…ç†å®Œæˆ"

  # é€šçŸ¥å’ŒæŠ¥å‘Š
  notify-results:
    name: é€šçŸ¥æµ‹è¯•ç»“æœ
    runs-on: ubuntu-latest
    needs: [validate-ai-config, code-quality, test-execution, ai-agent-test]
    if: always()
    steps:
      - name: ä¸‹è½½æ‰€æœ‰æŠ¥å‘Š
        uses: actions/download-artifact@v5
        with:
          path: ./reports
      
      - name: ç”Ÿæˆç»¼åˆæŠ¥å‘Š
        run: |
          echo "# AI Agentè‡ªåŠ¨åŒ–æµæ°´çº¿æŠ¥å‘Š" > pipeline-report.md
          echo "===============================" >> pipeline-report.md
          echo "" >> pipeline-report.md
          echo "**æ‰§è¡Œæ—¶é—´**: $(date)" >> pipeline-report.md
          echo "**è§¦å‘äº‹ä»¶**: ${{ github.event_name }}" >> pipeline-report.md
          echo "**åˆ†æ”¯**: ${{ github.ref }}" >> pipeline-report.md
          echo "**æäº¤**: ${{ github.sha }}" >> pipeline-report.md
          echo "" >> pipeline-report.md
          
          echo "## æµ‹è¯•ç»“æœ" >> pipeline-report.md
          echo "" >> pipeline-report.md
          echo "- AIé…ç½®éªŒè¯: ${{ needs.validate-ai-config.result }}" >> pipeline-report.md
          echo "- ä»£ç è´¨é‡æ£€æŸ¥: ${{ needs.code-quality.result }}" >> pipeline-report.md
          echo "- æµ‹è¯•æ‰§è¡Œ: ${{ needs.test-execution.result }}" >> pipeline-report.md
          echo "- AI Agentæµ‹è¯•: ${{ needs.ai-agent-test.result }}" >> pipeline-report.md
          echo "" >> pipeline-report.md
          
          echo "## æ€»ä½“çŠ¶æ€" >> pipeline-report.md
          if [[ "${{ needs.validate-ai-config.result }}" == "success" && "${{ needs.code-quality.result }}" == "success" && "${{ needs.test-execution.result }}" == "success" && "${{ needs.ai-agent-test.result }}" == "success" ]]; then
            echo "âœ… **æ‰€æœ‰æµ‹è¯•é€šè¿‡**" >> pipeline-report.md
          else
            echo "âŒ **éƒ¨åˆ†æµ‹è¯•å¤±è´¥**" >> pipeline-report.md
          fi
      
      - name: ä¸Šä¼ ç»¼åˆæŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-report
          path: pipeline-report.md
